# TODO:

### Add each phases responsibility and process in here.
  * What will argocd do? what phase does it mostly sit in?
  * What does the bootstrap phase do?

### Fix the git-crypt encryption from previous revision
  * check config folder

### Fix talosctl bootstrap code
  * move our kubeconfig over
  * make sure a healthcheck succeeds
  * fully automate with omni/netboot docker container in future

# Testing Strategy Summary (with Crossplane Composition + Nix VM Testing)

| Concern                                                              | Test? | Tool / Approach                                                                                   |
|----------------------------------------------------------------------|-------|----------------------------------------------------------------------------------------------------|
| âœ… Does my **Crossplane Composition render the correct resources**?  | Yes   | [KUTTL](https://kuttl.dev/) â€” assert that the right child resources are created                   |
| âœ… Does **data wiring** (e.g., image slug from secret â†’ Droplet) work?| Yes   | KUTTL or `kubectl get -o yaml` â€” verify fields are correctly populated                            |
| âœ… Does the **image build work and boot a working system**?          | Yes   | Use [Nix VM integration tests](https://nix.dev/tutorials/nixos/integration-testing-using-virtual-machines.html) to run and validate the image before publishing |
| ðŸš« Do **doctl** / `aws` upload steps work                            | Skip  | Assume correctness â€” optionally verify once manually or via logs                                  |
| ðŸš« Does DigitalOcean **Droplet provisioning** work at the API level  | Skip  | Assume DOâ€™s API is reliable â€” test only for integration at the Kubernetes level                   |
| ðŸš« Do **CDK8s chart internals** need testing                         | Skip  | Treat CDK8s output as plain YAML â€” test via Kubernetes behavior instead                           |

---

### ðŸ§ª Where to focus:

- âœ… **KUTTL**: Prove your Composition renders and wires correctly
- âœ… **Nix VM Test**: Ensure your NixOS system boots and behaves as expected before the image ever reaches DigitalOcean

You now have a clean split between:
- **Declarative testing**: via Kubernetes and KUTTL
- **Procedural system validation**: via Nix VM integration tests

# KUTTL + CDK8s Notes

## Goal
Use KUTTL to assert on resources generated by CDK8s.

## Key Fixes

- âœ… **Set explicit `.metadata.labels` on the Deployment**
  This ensures KUTTL can find the resource using a consistent `metadata.name` and label.

- âœ… **Set matching `.spec.selector.matchLabels` manually**
  CDK8s auto-generates a hash-based selector unless you override it.

- âœ… **Patch labels and selectors explicitly via escape hatches**
  ```ts
  ApiObject.of(dep).addJsonPatch(
    JsonPatch.add("/spec/selector/matchLabels/app", "demo-test"),
    JsonPatch.add("/spec/template/metadata/labels/app", "demo-test"),
  );
